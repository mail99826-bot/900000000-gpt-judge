<div class="viewport">
    <div class="shift-wrap">
        <div class="card">
            <button id="logToggle" class="log-toggle" title="Показать/скрыть лог">Лог</button>

            <!-- RU -->
            <div class="ru">{{Front}}</div>

            <!-- Блок ответов (один стиль/размер у обоих) -->
            <div class="answers-wrap">
                <div id="goldSection" class="section" style="display:none">
                    <div class="label">Эталонный перевод</div>
                    <div class="answer-line en gold">{{Back}}</div>
                </div>

                <div class="section">
                    <div class="label">Ваш ответ</div>
                    <div id="userAns" class="answer-line en user"></div>
                </div>
            </div>

            <!-- Ввод -->
            <div class="input-wrap">
                <textarea id="typeans" class="typebox" rows="2" placeholder="Введите перевод и нажмите Enter"
                    autofocus></textarea>
            </div>

            <!-- Панель с советом GPT -->
            <div id="gptPanel" class="gpt hidden" aria-live="polite">
                <div class="gpt-row">
                    <div class="gpt-badge">GPT</div>
                    <div class="gpt-text">
                        <div class="gpt-title">Рекомендация для повтора:</div>
                        <div class="gpt-body">
                            <span id="gptEase" class="gpt-ease"></span>
                            <span id="gptComment" class="gpt-comment"></span>
                        </div>
                    </div>
                </div>
                <div id="gptConfidence" class="gpt-confidence muted"></div>
            </div>

            <!-- История перенесена в самый низ -->
            <div id="historyPanel" class="history-panel" aria-live="polite"
                aria-label="История ввода (последние 3 строки)"></div>
        </div>
    </div>

    <!-- Лог сбоку -->
    <div id="logPanel" class="log-panel" aria-label="Журнал GPT">
        <div class="log-head">
            <div class="log-head-title">Журнал GPT</div>
            <button id="logClear" class="log-clear" title="Очистить">Очистить</button>
        </div>
        <div id="logBody" class="log-body" aria-live="polite"></div>
        <div class="log-footer">
            <div class="log-kv"><span>Отправлено токенов</span><b id="tokOut">0</b></div>
            <div class="log-kv"><span>Получено токенов</span><b id="tokIn">0</b></div>
            <div class="log-kv"><span>Всего токенов</span><b id="tokTotal">0</b></div>
            <div class="log-kv"><span>Оценка стоимости</span><b id="costUSD">—</b></div>
            <div class="log-kv"><span>Баланс</span><b id="balanceUSD">—</b></div>
        </div>
    </div>
</div>

<script>
    (function () {
        function $(s) { return document.querySelector(s); }
        var el = $('#typeans'), userAns = $('#userAns');
        var gptPanel = $('#gptPanel'), gptEase = $('#gptEase'), gptComment = $('#gptComment'), gptConf = $('#gptConfidence');
        var gold = document.getElementById('goldSection');

        /* === История (3 строки, сверху-вниз, сквозная нумерация) === */
        var historyPanel = $('#historyPanel');
        var HISTORY_LIMIT = 3;
        window._lineHistory = Array.isArray(window._lineHistory) ? window._lineHistory : [];
        window._lineCounter = Number.isInteger(window._lineCounter) ? window._lineCounter : 0;

        function renderHistory() {
            if (!historyPanel) return;
            historyPanel.innerHTML = '';
            if (!window._lineHistory.length) {
                var ph = document.createElement('div');
                ph.className = 'history-placeholder muted';
                ph.textContent = 'История пуста';
                historyPanel.appendChild(ph);
                return;
            }
            for (var i = 0; i < window._lineHistory.length; i++) {
                var data = window._lineHistory[i];
                var item = document.createElement('div');
                item.className = 'history-item muted-strong';

                var num = document.createElement('span');
                num.className = 'history-num';
                num.textContent = data.num + '.';

                var text = document.createElement('span');
                text.className = 'history-text';
                text.textContent = data.text;

                item.appendChild(num);
                item.appendChild(text);
                historyPanel.appendChild(item);
            }
        }

        function pushHistory(txt) {
            if (!txt) return;
            window._lineCounter += 1;
            window._lineHistory.push({ num: window._lineCounter, text: txt });
            if (window._lineHistory.length > HISTORY_LIMIT) window._lineHistory.shift();
            renderHistory();
        }

        /* === Лог === */
        var logToggle = $('#logToggle'), logClear = $('#logClear'), logBody = $('#logBody');
        var elTokOut = $('#tokOut'), elTokIn = $('#tokIn'), elTokTotal = $('#tokTotal'), elCost = $('#costUSD'), elBalance = $('#balanceUSD');
        var aggOut = 0, aggIn = 0, aggTotal = 0;

        function has(v) { return v !== undefined && v !== null; }
        function focusInput() { if (el) setTimeout(() => { try { el.focus(); } catch (e) { } }, 30); }
        function toggleLog() { document.body.classList.toggle('log-open'); focusInput(); }

        if (logToggle) logToggle.addEventListener('click', toggleLog);
        if (logClear) logClear.addEventListener('click', function () {
            if (logBody) logBody.innerHTML = '';
            aggOut = aggIn = aggTotal = 0;
            if (elTokOut) elTokOut.textContent = '0';
            if (elTokIn) elTokIn.textContent = '0';
            if (elTokTotal) elTokTotal.textContent = '0';
            if (elCost) elCost.textContent = '—';
            if (elBalance) elBalance.textContent = '—';
            focusInput();
        });

        function logAppend(obj) {
            try {
                var ts = new Date().toLocaleTimeString();
                var e = document.createElement('div'); e.className = 'log-entry';
                var text = (typeof obj === 'string') ? obj : JSON.stringify(obj, null, 2);
                e.textContent = '[' + ts + '] ' + text;
                if (logBody) { logBody.appendChild(e); logBody.scrollTop = logBody.scrollHeight; }

                var o = 0; if (obj && has(obj.prompt_tokens)) o = +obj.prompt_tokens; else if (obj && has(obj.in_tokens)) o = +obj.in_tokens;
                var i = 0; if (obj && has(obj.completion_tokens)) i = +obj.completion_tokens; else if (obj && has(obj.out_tokens)) i = +obj.out_tokens;
                var t = 0; if (obj && has(obj.total_tokens)) t = +obj.total_tokens; else t = o + i;

                if (!isNaN(o)) aggOut += o; if (!isNaN(i)) aggIn += i; if (!isNaN(t)) aggTotal += t;
                if (elTokOut) elTokOut.textContent = String(aggOut);
                if (elTokIn) elTokIn.textContent = String(aggIn);
                if (elTokTotal) elTokTotal.textContent = String(aggTotal);

                if (obj && typeof obj.cost_usd === 'number' && elCost) elCost.textContent = '$' + obj.cost_usd.toFixed(4);
                if (obj && typeof obj.balance_usd === 'number' && elBalance) elBalance.textContent = '$' + obj.balance_usд.toFixed(2);
            } catch (_) { }
        }
        window._ankiLogAppend = function (ev) {
            try { logAppend((typeof ev === 'string') ? JSON.parse(ev) : ev); } catch (e) { logAppend(ev); }
        };

        function highlightEase(ease) {
            for (var k = 1; k <= 4; k++) { var b = document.getElementById('ease' + k); if (b) b.classList.remove('ease-suggest'); }
            var t = document.getElementById('ease' + ease); if (t) t.classList.add('ease-suggest');
        }

        function showGptAdvice(o) {
            o = o || {};
            var ease = o.ease, comment = o.comment, conf = o.confidence, map = { 1: 'Again (1)', 2: 'Hard (2)', 3: 'Good (3)', 4: 'Easy (4)' };
            if (gptEase) {
                gptEase.textContent = ease ? ('Нажмите: ' + (map[ease] || ease)) : '';
                gptEase.className = 'gpt-ease';
                if (ease === 1) gptEase.classList.add('danger');
                else if (ease === 2) gptEase.classList.add('warn');
                else if (ease === 3) gptEase.classList.add('ok');
                else if (ease === 4) gptEase.classList.add('easy');
            }
            if (gptComment) gptComment.textContent = comment ? (' — ' + comment) : '';
            if (gptConf) gptConf.textContent = (typeof conf === 'number') ? ('Уверенность: ' + Math.round(conf * 100) + '%') : '';
            if (gptPanel) gptPanel.classList.remove('hidden');
            if (ease) highlightEase(ease);
        }

        /* === Зелёная подсветка во время проверки === */
        function setInputEvaluating(on) { if (el) el.classList.toggle('evaluating', !!on); }

        /* === Коллбек аддона: снимаем подсветку при завершении === */
        window._ankiAddonCallback = function (msg) {
            try {
                var d = (typeof msg === 'string') ? JSON.parse(msg) : msg;
                if (d && (d.ease !== undefined || d.comment !== undefined)) { showGptAdvice(d); }
            } catch (e) { /* ignore */ }
            setInputEvaluating(false);
        };
        window._ankiAddonCallbackBack = window._ankiAddonCallback;

        /* === Enter === */
        if (el) {
            el.addEventListener('keydown', function (ev) {
                if (ev.key === 'Enter') {
                    ev.preventDefault();
                    var txt = (el.value || '').trim();
                    if (!txt) return;

                    pushHistory(txt);
                    setInputEvaluating(true);

                    window._lastUserInput = txt;
                    if (userAns) userAns.textContent = txt;
                    if (gold) gold.style.display = '';
                    try { pycmd('judge:' + JSON.stringify({ text: txt, t: Date.now() })); } catch (e) { setInputEvaluating(false); }

                    el.value = '';
                    focusInput();
                }
            });
        }

        if (window._lastUserInput) { if (userAns) userAns.textContent = window._lastUserInput; if (gold) gold.style.display = ''; }
        renderHistory();

        window.addEventListener('keydown', function (e) {
            if (e.key === 'Escape' && document.body.classList.contains('log-open')) {
                document.body.classList.remove('log-open'); focusInput();
            }
        });

        setTimeout(() => { try { if (el && document.activeElement !== el) el.focus(); } catch (e) { } }, 0);
    })();
</script>